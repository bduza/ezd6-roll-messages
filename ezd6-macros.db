{"name":"Confirm Crit 5+","type":"script","author":"gxk0TBuEUutgkf9m","img":"modules/ezd6-roll-messages/inverted-dice-5-white.svg","scope":"global","command":"let pips = ['zero', 'one', 'two', 'three', 'four', 'five', 'six'];\nlet message = game.messages.contents.filter(m=>m.user==game.user&&m.flags.ezd6?.results?.length).reverse()[0];\nif (!message) \n  return ui.notifications.warn('No message with results found.');\nlet resultsActive6 = message.flags.ezd6?.results?.filter(r=>r.result>=5 && r.active);\nlet resultsOriginalCrit = !!resultsActive6.filter(r=>!r.hasOwnProperty('count') && r.active).length;\nlet confirmRolls = message.flags.ezd6?.results?.filter(r=>r.hasOwnProperty('count'));\nif (!message.flavor.toUpperCase().includes('ATTACK'))\n  return ui.notifications.warn('Your last roll was not an attack.');\nif (!resultsActive6.length)\n  return ui.notifications.warn('You did not roll a 5+ on your attack.');\nif (!resultsOriginalCrit)\n  return ui.notifications.warn('Your attack roll was not a 5+.');\nif (confirmRolls.length)\n  if (!confirmRolls.at(-1)?.success)\n    return ui.notifications.warn('Your last roll was not a 5+.');\nlet roll = await new Roll('1d6cs>=5').roll();\nif (game.modules.get('dice-so-nice')?.active)\n  await game.dice3d.showForRoll(roll, game.user, true);\nlet results = [...message.flags.ezd6.results, ...roll.dice.reduce((a,x)=>{return [...a, ...x.results]}, [])];\nlet actions = [];\nif (message.flags.ezd6.actions?.length)\n  actions = [...message.flags.ezd6.actions];\nactions.push(`Rolled die ${results.length} to confirm a crit - ${ezd6.d6pips[results[results.length-1].result]}`)\nawait  message.update({content:roll.total, flags:{ezd6:{results, actions}}});\nif (roll.total==1) this.execute();","ownership":{"default":2,"gxk0TBuEUutgkf9m":3},"flags":{"advanced-macros":{"runAsGM":false},"socketmacros":{"isSocket":false},"ezd6-roll-messages":{"id":"yvsVJnHmuJH3WZiI"}},"_stats":{"systemId":"ezd6","systemVersion":"1.1.1","coreVersion":"10.291","createdTime":1673650149601,"modifiedTime":1674214366041,"lastModifiedBy":"gxk0TBuEUutgkf9m"},"folder":null,"sort":0,"_id":"3Q3qlupwyvIXcMoE"}
{"name":"Buy Hero Die","type":"script","scope":"global","author":"gxk0TBuEUutgkf9m","img":"icons/svg/coins.svg","command":"if (character.system.herodice>0) \n  return ui.notifications.warn(\"You already have a Hero Die\");\nif (character.system.karma<5) \n  return ui.notifications.warn(\"You do not have enough karma to buy a Hero Die\");\nawait character.update({\n  system: {\n    karma: game.user.character.system.karma-5,\n    herodice: game.user.character.system.herodice+1\n  }\n});\nawait ChatMessage.create({speaker: ChatMessage.getSpeaker({actor:game.user.character}), content: `Spent 5 karma to buy a hero die.`});","ownership":{"default":2,"gxk0TBuEUutgkf9m":3,"pNR8bgLbPWFFipAO":2},"flags":{"advanced-macros":{"runAsGM":false},"socketmacros":{"isSocket":false},"ezd6-roll-messages":{"id":"evLJGu2jopzcV1R3"}},"_stats":{"systemId":"ezd6","systemVersion":"1.1.1","coreVersion":"10.291","createdTime":1667180422757,"modifiedTime":1674214366009,"lastModifiedBy":"gxk0TBuEUutgkf9m"},"folder":null,"sort":0,"_id":"3rN04gxUbwuBJMAV"}
{"name":"Attack","type":"script","scope":"global","author":"gxk0TBuEUutgkf9m","img":"icons/svg/sword.svg","command":"speaker = ChatMessage.getSpeaker()\nif (!character) character = actor;\nif (!character) \n  return ui.notifications.notify('No character or selected token. Please assign a character or select a token.');\nlet formula = await ezd6.rollDialog(\"Attack Roll\");\nif (!formula) return ui.notifications.info(\"Roll Cancelled\");\nawait new Roll(`${formula}`).toMessage({speaker, flavor: `Attack Roll: ${formula}`, \"flags.ezd6.targets\": [...game.user.targets.map(t=>t.document.uuid)]});","ownership":{"default":2,"gxk0TBuEUutgkf9m":3,"pNR8bgLbPWFFipAO":2},"flags":{"advanced-macros":{"runAsGM":false},"socketmacros":{"isSocket":false},"ezd6-roll-messages":{"id":"JAJAOQaIVH1G0tn4"}},"_stats":{"systemId":"ezd6","systemVersion":"1.1.1","coreVersion":"10.291","createdTime":1667131241782,"modifiedTime":1674214365932,"lastModifiedBy":"gxk0TBuEUutgkf9m"},"folder":null,"sort":0,"_id":"7ODpwf2L5sSSpVVb"}
{"name":"Cast","type":"script","scope":"global","author":"gxk0TBuEUutgkf9m","img":"icons/svg/daze.svg","command":"speaker = ChatMessage.getSpeaker()\nif (!character) character = actor;\nif (!character) \n  return ui.notifications.notify('No character or selected token. Please assign a character or select a token.');\nlet formula = await ezd6.magickDialog(\"Cast Spell/Miracle\");\nif (!formula) return ui.notifications.info(\"Cast Cancelled\");\nawait new Roll(formula).toMessage({speaker, flavor: 'Cast Roll: ' + formula});","ownership":{"default":2,"gxk0TBuEUutgkf9m":3,"pNR8bgLbPWFFipAO":2},"flags":{"advanced-macros":{"runAsGM":false},"socketmacros":{"isSocket":false},"ezd6-roll-messages":{"id":"cflW1na61BT0Ra0x"}},"_stats":{"systemId":"ezd6","systemVersion":"1.1.1","coreVersion":"10.291","createdTime":1667138806065,"modifiedTime":1674214365982,"lastModifiedBy":"gxk0TBuEUutgkf9m"},"folder":null,"sort":0,"_id":"F3v1Nw26xUnI5iwJ"}
{"name":"Roll Resistance/Aloofness","type":"script","scope":"global","author":"gxk0TBuEUutgkf9m","img":"icons/svg/stoned.svg","command":"let type = 'Resistance'\nif (game.user.isGM)\ntype = await new Promise((resolve)=>{\n        new Dialog({\n         title: 'Resistance or Aloofness?',\n         content:  ``,\n         render: (html) => {\n           html.parent().css({background:'unset', color: 'white'})\n            html.find('button, input').css({background:'unset', color: 'white'})\n         },\n         buttons: {\n             resist : { label : `Resistance`, callback : (html) => {resolve(`Resistance`);}},\n             aloof : { label : `Aloofness`, callback : (html) => {resolve(`Aloofness`);}}\n         },\n         default: 'resist',\n         close:   html => {\n             return resolve('')}\n           },{top: window.innerHeight-300, width: 'auto', id: \"R-or-F\"}\n        ).render(true);\n    });\nif (!type) return ui.notifications.info(\"Resist or Aloof not selected\");\nlet formula = await ezd6.magickDialog(`${type} Roll`);\nif (!formula) return ui.notifications.info(\"Spell Cast Cancelled\");\nreturn await new Roll(formula).toMessage({flavor: `${type} Roll: ` + formula});","ownership":{"default":2,"gxk0TBuEUutgkf9m":3},"flags":{"advanced-macros":{"runAsGM":false},"socketmacros":{"isSocket":false},"ezd6-roll-messages":{"id":"yGbebxaD52rblKfC"}},"_stats":{"systemId":"ezd6","systemVersion":"1.1.1","coreVersion":"10.291","createdTime":1667148258410,"modifiedTime":1674214366036,"lastModifiedBy":"gxk0TBuEUutgkf9m"},"folder":null,"sort":0,"_id":"OFlB7riq5oLRz7W3"}
{"name":"Armor Save","type":"script","scope":"global","author":"gxk0TBuEUutgkf9m","img":"icons/svg/shield.svg","command":"speaker = ChatMessage.getSpeaker()\nif (!character) character = actor;\nif (!character) \n  return ui.notifications.notify('No character or selected token. Please assign a character or select a token.');\nlet formula = await ezd6.rollDialog(\"Armor Save\");\nif (!formula) return ui.notifications.info(\"Roll Cancelled\");\nlet roll = await new Roll(`${formula}cs>=${character.system.armorsave}`).roll();\nroll.toMessage({speaker , flavor: 'Armor Save: ' + roll.formula});","ownership":{"default":2,"gxk0TBuEUutgkf9m":3,"pNR8bgLbPWFFipAO":2},"flags":{"advanced-macros":{"runAsGM":false},"socketmacros":{"isSocket":false},"ezd6-roll-messages":{"id":"5Gy8DOS0sF4X1Bbq"}},"_stats":{"systemId":"ezd6","systemVersion":"1.1.1","coreVersion":"10.291","createdTime":1667151891064,"modifiedTime":1674214365917,"lastModifiedBy":"gxk0TBuEUutgkf9m"},"folder":null,"sort":0,"_id":"YUT71TUF9iZxl5Wx"}
{"name":"EZd6 Player Dialog","type":"script","author":"gxk0TBuEUutgkf9m","img":"icons/svg/cowled.svg","scope":"global","command":"let id = 'ezd6-player-dialog';\nif ($(`div#${id}`).length) \n  return ui.windows[$(`div#${id}`).data().appid].render(true).bringToTop();\n\nlet columns = [ \n  [\"strikes.value\",   ezd6.strikes   , \"Strikes\"], \n  [\"herodice\",   ezd6.herodice     , \"Hero Dice\"],\n  [\"karma\",   ezd6.karma, \"Karma\"]\n  ];\nlet d = new Dialog({title: `EZD6 P&S Dialog` ,  content: ``,  buttons: {},  render: async (html)=>{\nhtml.first().parent().css({background:'unset'});\nlet div = `<div class=\"${id}\" style=\"\"> \n<style>\n#${id} {width:auto !important;}\ndiv.${id} { width:auto !important; height: max-content; margin-top:0px;  z-index: 29;}\ndiv.macro > a.macro > img {border:unset;}\ndiv.macro > a.macro > img:hover {filter: drop-shadow(0px 0px 3px rgb(255 0 0 / 0.9)) !important;\nspan.icons {margin-left: .5em}\n}\n</style><div style=\"width: max-content; display:grid; grid-template-columns: auto auto; column-gap: .75em; row-gap: .25em; color: white; font-size: 20px;\">`;\n\nfor (let user of game.users.filter(u=>u.character))\n  div += `<span>${user.character.name}</span>` + columns.reduce((acc, x, i)=>acc+=`<span>${Array(foundry.utils.getProperty(user.character.system, x[0])+1).join(x[1]+\"&ensp;\")}${i==0?Array(Math.max(user.character.system.strikes.max-user.character.system.strikes.value+1, 0)).join('<i class=\"fa-solid fa-heart\" style=\"color: black;-webkit-text-stroke: 1px red;\"></i>&ensp;'):''}</span>`, `<span class=\"header-stats\" style=\"margin-left:.5em;\">`)+`<style>.ezd6.sheet.character.minimized{width:auto !important;}</style></span>`;\n  \n\ndiv += `</div>`\nlet $div = $(div);\nhtml.first().append($div);\n},//end render\n  close: async (html)=>{\n      //delete character.apps[d.appId];\n      if (Hooks.sheetHook) Hooks.off('', Hooks.sheetHook);\n      if (Hooks.ezd6playerui) Hooks.off('', Hooks.ezd6playerui)\n      return;\n    }\n}, {width: 'auto', height: 'auto', id}\n).render(true);\ncharacter.apps[d.appId] = d;\n\n\nif (Hooks.ezd6playerui) Hooks.off('', Hooks.ezd6playerui)\nHooks.ezd6playerui = \n  Hooks.on('updateActor', (actor, updates)=>{\n    d.render(true, {height: 'auto', width: 'auto'})\n  })","ownership":{"default":2,"gxk0TBuEUutgkf9m":3,"pNR8bgLbPWFFipAO":2},"flags":{"advanced-macros":{"runAsGM":false},"socketmacros":{"isSocket":false},"ezd6-roll-messages":{"id":"YKjEjtLY1jE3cvCH"}},"_stats":{"systemId":"ezd6","systemVersion":"1.1.1","coreVersion":"10.291","createdTime":1670156561005,"modifiedTime":1674214365938,"lastModifiedBy":"gxk0TBuEUutgkf9m"},"folder":null,"sort":0,"_id":"ao3feBLoXieNz6HN"}
{"name":"EZD6 RR Dialog","type":"script","author":"gxk0TBuEUutgkf9m","img":"systems/ezd6/assets/icons/dmscotty_white_nobg.webp","scope":"global","command":"if (!game.user.isGM) return;\nlet id = 'ezd6-rr-dialog';\nif ($(`div#${id}`).length) \n  return ui.windows[$(`div#${id}`).data().appid].render(true).bringToTop();\n  \nlet columns = [ \n    {key:\"name\", icon:'<i class=\"fa-solid fa-user\"></i>', label:\"User Name\"}, \n    {key:\"armorsave\", icon: '<i class=\"fa-solid fa-shield\"></i>', label: \"Wound Save\"}, \n    {key:\"miraculoussave\", icon: '<i class=\"fa-solid fa-hand-holding-heart\"></i>', label:\"Miraculous Save\"}, \n    {key:\"strikes.value\", icon: ezd6.strikes, label:\"Strike\"}, \n    {key:\"herodice\", icon: ezd6.herodice, label:\"Hero Die\"},\n    {key:\"karma\", icon: ezd6.karma, label: \"Karma\"}\n  ];\n  \nlet d = new Dialog({title: \"EZD6 RR Dialog\",  content: ``,  buttons: {},  render: async (html)=>{\n    //position: absolute; top: 30px; left: 0px;\nhtml.first().parent().css({background:'unset'})//border: 1px solid var(--color-border-dark);border-radius: 5px; background-image: url(../ui/denim075.png); \nlet div = `<div class=\"${id}\"> \n<style>\ndiv.${id} {  width: max-content; height: max-content;}\n</style>\n<div style=\"display:grid; grid-template-columns: repeat(${columns.length}, auto); column-gap: .75em; row-gap: .25em; color: white; font-size: 20px;\">`;\n  div += columns.reduce((acc, x, i)=>acc+=`<div style=\"border-bottom: 1px solid white;\" title=\"${x.name}\">${x.icon}</div>`, ``);\nfor (let user of game.users.filter(u=>!!u.character))//.filter(u=>!u.isGM)) \n  div += columns.reduce((acc, x, i)=>acc+=`<div style=\"text-align:${i?\"center\":\"left\"};\" title=\"${foundry.utils.hasProperty(user.character.system, x.key)?x.label:user.name}\"><a class=\"ezd6-ui-link\" data-key=\"${x.key}\" data-label=\"${x.label}\" data-user=\"${user.id}\">${foundry.utils.hasProperty(user.character.system, x.key)?foundry.utils.getProperty(user.character.system, x.key):`<img src=\"${user.character.img}\" height=20>&nbsp;${user.character.name}`}</a></div>`, ``);\ndiv += `</div></div>`;\nlet $div = $(div);\n\n$div.find(`a.ezd6-ui-link`).click(async function(e){\n  let user = game.users.get(this.dataset.user);\n  let character = user.character;\n  if (this.dataset.key==\"strikes.value\" && !e.originalEvent && user.character.system.strikes.value == user.character.system.strikes.max) return ui.notifications.warn(`Max strikes reached.`);\n  if (foundry.utils.getProperty(user.character.system, this.dataset.key)-1<0 && !!e.originalEvent) return ui.notifications.warn(`Value cannot be negative.`);\n  if (!foundry.utils.hasProperty(user.character.system, this.dataset.key) && !!e.originalEvent) \n    return character.sheet.render(true);\n  if (!foundry.utils.hasProperty(user.character.system, this.dataset.key) && !e.originalEvent)\n    return game.macros.getName('Freeform Character Sheet').execute(character.id);\n  //if (this.dataset.key==\"hd\" && user.flags.ezd6[\"hd\"]==1 && !e.originalEvent) //\n  //return ui.notifications.warn(\"A player may only have 1 hero die.\");\n  await character.update({system:{[this.dataset.key]: (e.shiftKey||!!e.originalEvent)?+foundry.utils.getProperty(character.system, this.dataset.key)-1:+foundry.utils.getProperty(character.system, this.dataset.key)+1}});\n  let tokens = character.getActiveTokens();\n  let down = (e.shiftKey||!!e.originalEvent);\n  let text = this.dataset.label.endsWith('s')?this.dataset.label.substring(0, 6).toLowerCase():this.dataset.label.toLowerCase()\n  //ChatMessage.create({content: `${down?'takes':'gives'} a ${this.dataset.label} ${down?'from':'to'} ${character.name} - ${columns.find(e=>e.key==this.dataset.key).icon}`})\n  text = (down?'- ':'+ ') + text ;\n  for (let t of tokens)\n  canvas.interface.createScrollingText(t.center, text, {\n        anchor: CONST.TEXT_ANCHOR_POINTS.CENTER,\n        direction: down ? CONST.TEXT_ANCHOR_POINTS.BOTTOM: CONST.TEXT_ANCHOR_POINTS.TOP,\n        distance: (2 * t.h),\n        fontSize: 28,\n        stroke: 0x000000,\n        strokeThickness: 4,\n        jitter: 0.25\n      });\n  //ChatMessage.create({content : `${character.name} ${(e.shiftKey||!!e.originalEvent)?\"loses\":\"gains\"} a ${this.dataset.label.endsWith('s')?this.dataset.label.substring(0, 6).toLowerCase():this.dataset.label.toLowerCase()}`})\n}).contextmenu(async function(e){ $(this).click(); })\nhtml.first().append($div);\n\n// return to dialog definition\n},\n  close: async (html)=>{\n      if (Hooks.ezd6gmui) Hooks.off('', Hooks.ezd6gmui)\n      return;\n    }\n}, {width: 'auto', height: 'auto', id}\n).render(true);\n\nif (Hooks.ezd6gmui) Hooks.off('', Hooks.ezd6gmui)\nHooks.ezd6gmui = \n  Hooks.on('updateActor', (actor, updates)=>{\n    d.render(true, {height: 'auto', width: 'auto'})\n  })","ownership":{"default":2,"gxk0TBuEUutgkf9m":3},"flags":{"advanced-macros":{"runAsGM":false},"socketmacros":{"isSocket":false},"ezd6-roll-messages":{"id":"p94lfDGBptTDhBiO"}},"_stats":{"systemId":"ezd6","systemVersion":"1.1.1","coreVersion":"10.291","createdTime":1670154475753,"modifiedTime":1674214366030,"lastModifiedBy":"gxk0TBuEUutgkf9m"},"folder":null,"sort":0,"_id":"jsIfyz0OJu8drFkm"}
{"name":"Miraculous Save","type":"script","scope":"global","author":"gxk0TBuEUutgkf9m","img":"icons/svg/angel.svg","command":"speaker = ChatMessage.getSpeaker()\nif (!character) character = actor;\nif (!character) \n  return ui.notifications.notify('No character or selected token. Please assign a character or select a token.');\nlet formula = await ezd6.rollDialog(\"Miraculous Save\");\nif (!formula) return ui.notifications.info(\"Roll Cancelled\");\nlet roll = await new Roll(`${formula}cs>=${character.system.miraculoussave}`).roll();\nroll.toMessage({speaker, flavor: 'Miraculous Save: ' + roll.formula});","ownership":{"default":2,"gxk0TBuEUutgkf9m":3,"pNR8bgLbPWFFipAO":2},"flags":{"advanced-macros":{"runAsGM":false},"socketmacros":{"isSocket":false},"ezd6-roll-messages":{"id":"nVzixaVyhuI6BdGt"}},"_stats":{"systemId":"ezd6","systemVersion":"1.1.1","coreVersion":"10.291","createdTime":1667151876563,"modifiedTime":1674214366019,"lastModifiedBy":"gxk0TBuEUutgkf9m"},"folder":null,"sort":0,"_id":"oqlV0rxTH4RuVnqw"}
{"name":"Perform Task","type":"script","scope":"global","author":"gxk0TBuEUutgkf9m","img":"icons/svg/falling.svg","command":"speaker = ChatMessage.getSpeaker()\nif (!character) character = actor;\nif (!character) \n  return ui.notifications.notify('No character or selected token. Please assign a character or select a token.');\nlet formula = await ezd6.rollDialog(\"Task Roll\");\nif (!formula) return ui.notifications.info(\"Task Cancelled\");\nawait new Roll(formula).toMessage({speaker ,flavor: 'Task Roll: ' + formula});","ownership":{"default":2,"gxk0TBuEUutgkf9m":3,"pNR8bgLbPWFFipAO":2},"flags":{"advanced-macros":{"runAsGM":false},"socketmacros":{"isSocket":false},"ezd6-roll-messages":{"id":"9RKmXJNnkFZSEH6m"}},"_stats":{"systemId":"ezd6","systemVersion":"1.1.1","coreVersion":"10.291","createdTime":1667148861300,"modifiedTime":1674214365922,"lastModifiedBy":"gxk0TBuEUutgkf9m"},"folder":null,"sort":0,"_id":"sFZNdB0Oy45OHDRv"}
{"name":"Confirm Crit","type":"script","scope":"global","author":"gxk0TBuEUutgkf9m","img":"modules/ezd6-roll-messages/inverted-dice-6-white.svg","command":"let pips = ['zero', 'one', 'two', 'three', 'four', 'five', 'six'];\nlet message = game.messages.contents.filter(m=>m.user==game.user&&m.flags.ezd6?.results?.length).reverse()[0];\n\nif (!message) \n  return ui.notifications.warn('No message with results found.');\nlet resultsActive6 = message.flags.ezd6?.results?.filter(r=>r.result==6 && r.active);\nlet resultsOriginalCrit = !!resultsActive6.filter(r=>!r.hasOwnProperty('count') && r.active).length;\nlet confirmRolls = message.flags.ezd6?.results?.filter(r=>r.hasOwnProperty('count'));\nif (!message.flavor.toUpperCase().includes('ATTACK'))\n  return ui.notifications.warn('Your last roll was not an attack.');\nif (!resultsActive6.length)\n  return ui.notifications.warn('You did not roll a 6 on your attack.');\nif (!resultsOriginalCrit)\n  return ui.notifications.warn('Your attack roll was not a 6.');\nif (confirmRolls.length)\n  if (!confirmRolls.at(-1)?.success)\n    return ui.notifications.warn('Your last roll was not a 6.');\nlet roll = await new Roll('1d6cs=6').roll();\nif (game.modules.get('dice-so-nice')?.active)\n  await game.dice3d.showForRoll(roll, game.user, true);\nlet results = [...message.flags.ezd6.results, ...roll.dice.reduce((a,x)=>{return [...a, ...x.results]}, [])];\nlet actions = [];\nif (message.flags.ezd6.actions?.length)\n  actions = [...message.flags.ezd6.actions];\nactions.push(`Rolled die ${results.length} to confirm a crit - ${ezd6.d6pips[results[results.length-1].result]}`)\nawait message.update({content:roll.total, flags:{ezd6:{results, actions}}});\nconsole.log(roll)\nif (roll.total==1) this.execute();","ownership":{"default":2,"gxk0TBuEUutgkf9m":3,"pNR8bgLbPWFFipAO":2},"flags":{"advanced-macros":{"runAsGM":false},"socketmacros":{"isSocket":false},"ezd6-roll-messages":{"id":"DCvTbOhdbTaqrDz7"}},"_stats":{"systemId":"ezd6","systemVersion":"1.1.1","coreVersion":"10.291","createdTime":1667135988098,"modifiedTime":1674214365927,"lastModifiedBy":"gxk0TBuEUutgkf9m"},"folder":null,"sort":0,"_id":"uNLSIgjrnmPpakr2"}
